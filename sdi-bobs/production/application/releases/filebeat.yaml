apiVersion: helm.fluxcd.io/v1
kind: HelmRelease
metadata:
  name: filebeat
  namespace: logging
spec:
  releaseName: filebeat
  chart:
    repository: https://kubernetes-charts.storage.googleapis.com
    name: filebeat
    version: 1.7.0
  values:
    extraVolumeMounts:
      - mountPath: /var/run/docker.sock
        name: var-run-docker-sock
        readOnly: true
    extraVolumes:
      - name: var-run-docker-sock
        hostPath:
          path: /var/run/docker.sock
          type: Socket
    indexTemplateLoad:
      - https://vpc-production-logs-h5thmymtp327yrdyej2mi2cm4a.us-east-1.es.amazonaws.com:443
    image:
      tag: 7.0.0
    overrideConfig:
      filebeat.config:
        modules:
          path: ${path.config}/modules.d/*.yml
          reload.enabled: false
      filebeat.inputs:
        - type: log
          paths: ['/var/log/*.log', '/var/log/messages', '/var/log/syslog']
          enabled: true
        - type: docker
          containers.ids: ['*']
          processors:
            - add_docker_metadata:
                labels.dedot: true
            - add_kubernetes_metadata:
                annotations.dedot: true
                labels.dedot: true
                in_cluster: true
          enabled: true
      http.enabled: true
      http.port: 5066
      logging:
        level: warning
      processors:
        - add_cloud_metadata: {}
      output:
        elasticsearch:
          protocol: https
          hosts:
            - vpc-production-logs-h5thmymtp327yrdyej2mi2cm4a.us-east-1.es.amazonaws.com:443
