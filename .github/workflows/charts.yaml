---
name: Charts
env:
  HELM_PLUGINS: ~/.helm/plugins
  HELM_REPOSITORY_NAME: reaction-charts
  HELM_REPOSITORY_URL: s3://sdi-management-helm-charts
on: [push]
jobs:
  setup:
    runs-on: ubuntu-latest
    env:
      GIT_TERMINAL_PROMPT: 0
      GITHUB_PAT: ${{ secrets.FRASERSLABS_GITHUB_PAT }}
    permissions: read-all
    steps:
      - uses: actions/checkout@v2
      - uses: actions/cache@v2
        id: tools
        with:
          path: ~/.asdf
          key: tools-${{ hashFiles('.uuidgen', '.tool-versions', 'requirements.txt') }}
      - run: .github/scripts/asdf.sh
      - run: make all -f scripts/asdf.mk
      - run: make deps HELM_CHARTS=
        if: steps.tools.outputs.cache-hit != 'true'

  lint:
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: asdf cache
        uses: actions/cache@v2
        with:
          path: ~/.asdf
          key: tools-${{ hashFiles('.uuidgen', '.tool-versions', 'requirements.txt') }}
      - name: asdf env
        run: .github/scripts/asdf.sh
      - run: make lint

  test:
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: asdf cache
        uses: actions/cache@v2
        with:
          path: ~/.asdf
          key: tools-${{ hashFiles('.uuidgen', '.tool-versions', 'requirements.txt') }}
      - name: asdf env
        run: .github/scripts/asdf.sh
      - run: make test ARGS="--junitxml=reports/junit.xml"
      - uses: EnricoMi/publish-unit-test-result-action@v1
        if: always()
        with:
          files: reports/junit.xml

  packages:
    runs-on: ubuntu-latest
    needs: [lint,test]
    if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/ci'
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: asdf cache
        uses: actions/cache@v2
        with:
          path: ~/.asdf
          key: tools-${{ hashFiles('.uuidgen', '.tool-versions', 'requirements.txt') }}
      - name: asdf env
        run: ./.github/scripts/asdf.sh
      - name: aws configure
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-region: us-east-1
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      - name: helm cache
        uses: actions/cache@v2
        id: helm-plugins
        with:
          path: ${env.HELM_PLUGINS}
          key: helm-plugins-${{ hashFiles('.uuidgen') }}
      - run: make plugins
        if: steps.helm-plugins.outputs.cache-hit != 'true'
      - run: make repo-add
      - run: make packages
